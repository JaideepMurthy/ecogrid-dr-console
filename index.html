<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EcoGrid DR Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="{ currentView: 'grid' }" class="app-body">
  <header class="app-header">
    <div class="app-title">EcoGrid DR Console</div>
    <nav class="app-nav">
      <button :class="{'active': currentView === 'grid'}" @click="currentView = 'grid'">Grid Overview</button>
      <button :class="{'active': currentView === 'forecast'}" @click="currentView = 'forecast'">Peak Forecast</button>
      <button :class="{'active': currentView === 'dr'}" @click="currentView = 'dr'">DR Console</button>
      <button :class="{'active': currentView === 'history'}" @click="currentView = 'history'">Event History</button>
    </nav>
  </header>

  <main class="app-main">
    <section x-show="currentView === 'grid'" class="view-section" id="view-grid">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h1>Grid Overview</h1>
        <div id="dataSourceLabel" style="background: #f39c12; padding: 6px 12px; border-radius: 4px; font-size: 0.85em; color: #fff; font-weight: bold;">üü° Demo: Synthetic Data</div>
      </div>
      <div id="grid-kpis" class="kpi-row"></div>
      <div class="chart-container"><canvas id="chart-demand-supply"></canvas></div>
      <div class="chart-container"><canvas id="chart-price"></canvas></div>
      <div class="chart-container"><canvas id="chart-production-mix"></canvas></div>
      <button id="btn-refresh-grid" class="primary-btn">Refresh data</button>
      <p class="hint-text">Uses public Portugal electricity data, cached locally for fast demos.</p>
    </section>

    <section x-show="currentView === 'forecast'" class="view-section" id="view-forecast">
      <h1>Peak Risk Forecast</h1>
      <div id="forecast-timeline" class="forecast-timeline"></div>
      <p id="forecast-summary" class="hint-text"></p>
      <button id="btn-plan-dr" class="primary-btn">Plan DR Event for peak window</button>
              <button id="btn-drill-down" class="secondary-btn" style="margin-left: 8px; padding: 8px 16px; background: #4ECDC4; color: white; border: none; border-radius: 4px; cursor: pointer;">üîç Factor Breakdown</button>
    </section>

    <section x-show="currentView === 'dr'" class="view-section" id="view-dr">
      <h1>DR Event Console</h1>
      <form id="dr-form" class="dr-form">
                  <label style="margin-bottom: 15px;">Operator Name <input type="text" id="operator-name" placeholder="Your name (for audit trail)" style="width:100%; padding:8px;" /></label>
        <label>Target reduction (MW) <input type="number" id="dr-target-mw" required min="10" step="10" /></label>
        <label>Start time (local) <input type="datetime-local" id="dr-start-time" required /></label>
<label>Duration (hours) <input type="number" id="dr-duration-hours" required min="0.5" step="0.5" /></label>
                  <label style="margin-top: 15px;">Ramping Profile (min to reach full reduction): <input type="range" id="dr-ramp-min" min="5" max="30" value="10" step="5" /><span id="ramp-display">10 min</span></label>
        <fieldset>
          <legend>Segments (share of flexible load)</legend>
          <label>Industrial & Commercial HVAC (%) <input type="number" id="seg-industrial" value="40" min="0" max="100" /></label>
          <label>EV charging fleets (%) <input type="number" id="seg-ev" value="35" min="0" max="100" /></label>
          <label>Commercial refrigeration (%) <input type="number" id="seg-commercial" value="25" min="0" max="100" /></label>
        </fieldset>
        <button type="submit" class="primary-btn">Simulate DR Event</button>
      </form>
      <section id="dr-result" class="dr-result"></section>
    </section>

    <section x-show="currentView === 'history'" class="view-section" id="90
      ">
      <h1>Event History & ROI</h1>
       <button id="btn-export-audit" class="primary-btn" style="margin-bottom: 16px;">üìã Export Compliance Report (CSV)</button>
      <div id="history-aggregates" class="kpi-row"></div>
      <div class="chart-container"><canvas id="chart-history-mw"></canvas></div>
      <div class="chart-container"><canvas id="chart-history-cost"></canvas></div>
      <table id="history-table" class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Target MW</th>
            <th>Achieved MW</th>
            <th>Duration (h)</th>
            <th>EUR Saved</th>
            <th>CO2 Avoided (t)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer class="app-footer"><span>EcoGrid DR Console - TecStorm Demo</span></footer>
  <script type="module" src="js/app.js"></script>
  <script>
  document.getElementById('dr-ramp-min')?.addEventListener('input', (e) => {
    document.getElementById('ramp-display').textContent = e.target.value + ' min';
  });
      // Factor drill-down modal
  const btnDrillDown = document.getElementById('btn-drill-down');
  if (btnDrillDown) {
    btnDrillDown.addEventListener('click', () => {
      const factors = {
        'High Demand': '73%',
        'Low Renewables': '12%',
        'Price Spike': '11%',
        'Grid Volatility': '4%'
      };
      let html = '<h3 style="color: #4ECDC4; margin-bottom: 16px;">üìä Risk Factor Breakdown</h3>';
      for (const [factor, weight] of Object.entries(factors)) {
        html += `<div style="margin-bottom: 12px;">`;
        html += `<div style="font-weight: 600; margin-bottom: 4px;">${factor}: <span style="color: #4ECDC4;">${weight}</span></div>`;
        html += `<div style="background: rgba(78, 205, 196, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">`;
        html += `<div style="background: #4ECDC4; height: 100%; width: ${weight}; transition: all 0.3s;"></div>`;
        html += `</div></div>`;
      }
      alert(html.replace(/<[^>]*>/g, ''));
    });
  }
</script>
</body>
</html>
